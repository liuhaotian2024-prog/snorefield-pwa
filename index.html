<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>SnoreField — Sensory Feedback</title>
  <style>
    :root{ --bg:#000000; --surface:#1c1c1e; --surface-2:#2c2c2e; --txt:#ffffff; --muted:#8e8e93; --accent:#0a84ff; --accent-glow:rgba(10,132,255,0.4); --danger:#ff453a; --success:#32d74b; --warn:#ff9f0a; }
    html,body{height:100%; overflow:hidden;}
    body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--txt); display:flex; flex-direction:column; -webkit-font-smoothing: antialiased; }
    
    .stage{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; z-index:10; }
    .orb-container{ position:relative; width:220px; height:220px; margin-bottom:40px; display:flex; align-items:center; justify-content:center; }
    
    /* THE ORB */
    .orb{ 
      width:140px; height:140px; border-radius:50%; 
      background: linear-gradient(145deg, #2c2c2e, #1c1c1e); 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.1); 
      border: 1px solid #3a3a3c; 
      display:flex; align-items:center; justify-content:center; 
      cursor:pointer; position:relative; z-index:10; 
      transition: transform 0.1s;
    }
    .orb:active { transform: scale(0.95); }
    .orb svg{ width:50px; height:50px; fill:var(--txt); }
    .orb.active{ background: var(--accent); border-color: var(--accent); box-shadow: 0 0 50px var(--accent-glow); }
    .orb.active svg{ fill:white; }

    /* RIPPLE SYSTEM (Multi-Layer) */
    .ripple {
      position:absolute; top:50%; left:50%; transform: translate(-50%, -50%);
      width:140px; height:140px; border-radius:50%; 
      border: 2px solid var(--accent);
      opacity: 0; pointer-events:none; z-index: 1;
    }
    
    /* Animation: Breathe (Default) */
    .orb.active ~ .ripple.r1 { animation: breathe 6s ease-in-out infinite; }
    .orb.active ~ .ripple.r2 { animation: breathe 6s ease-in-out infinite 0.2s; }
    
    @keyframes breathe {
      0% { width:140px; height:140px; opacity:0; border-color:var(--accent); }
      50% { width:180px; height:180px; opacity:0.3; } 
      100% { width:140px; height:140px; opacity:0; }
    }

    /* Animation: INTERVENTION (Sonar Ping) */
    .orb.intervening ~ .ripple.r1 { animation: ping 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite; border-color: var(--warn); border-width: 4px; }
    .orb.intervening ~ .ripple.r2 { animation: ping 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite 0.3s; border-color: var(--warn); }
    .orb.intervening ~ .ripple.r3 { animation: ping 1.5s cubic-bezier(0, 0.2, 0.8, 1) infinite 0.6s; border-color: var(--warn); }

    @keyframes ping {
      0% { width:140px; height:140px; opacity:0.8; }
      100% { width:300px; height:300px; opacity:0; }
    }
    
    .status-text{ font-size:16px; color:var(--txt); font-weight:600; margin-top:20px; text-align:center; height:24px;}
    .sub-status { font-size: 12px; color: var(--muted); margin-top: 6px; font-family: monospace; }
    
    .controls{ width:100%; max-width:340px; padding:0 24px; box-sizing:border-box; display:flex; flex-direction:column; gap:24px; }
    .control-group label{ display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-bottom:10px; font-weight:600;}
    .control-group label span.val{ color:var(--txt); font-family:monospace; }
    
    input[type=range] { -webkit-appearance:none; width:100%; background:transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--surface-2); border-radius: 2px; }
    
    .select-wrap{ position:relative; }
    select{ width:100%; -webkit-appearance:none; background:var(--surface); border:none; color:var(--txt); padding:16px; border-radius:14px; font-size:16px; outline:none; }
    .select-wrap::after{ content:"▼"; position:absolute; right:16px; top:18px; font-size:10px; color:var(--muted); pointer-events:none; }
    
    .footer-bar{ padding:30px; display:flex; justify-content:center; gap:30px; background:var(--bg); z-index:20; }
    .icon-btn{ background:var(--surface); border:none; color:var(--muted); cursor:pointer; padding:12px; border-radius:50%; }
    .icon-btn:hover{ background:var(--surface-2); color:var(--txt); }
    
    .advanced-panel{ position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:30; transform:translateY(100%); transition:transform 0.35s cubic-bezier(0.16, 1, 0.3, 1); display:flex; flex-direction:column; }
    .advanced-panel.open{ transform:translateY(0); }
    .adv-header{ padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--surface-2); background:var(--surface); }
    .adv-content{ flex:1; overflow-y:auto; padding:20px; display:grid; gap:20px; align-content:start; }
    .card{ background:var(--surface); border-radius:16px; padding:18px; }
    .grid-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .kpi-box{ background:rgba(255,255,255,0.05); border-radius:10px; padding:10px; text-align:center; }
    .kpi-box .l{ font-size:10px; color:var(--muted); display:block; margin-bottom:4px;}
    .kpi-box .v{ font-size:15px; font-weight:700; font-family:monospace; color:#fff; }
    .btn{ width:100%; padding:14px; border-radius:12px; border:none; background:var(--surface-2); color:var(--txt); font-weight:600; cursor:pointer; font-size:15px; }
    .btn.danger{ background:rgba(255, 69, 58, 0.15); color:var(--danger); }
    input[type=checkbox] { transform: scale(1.3); accent-color: var(--accent); }
    .demo-tag { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: #ff9f0a; color: black; font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 4px; display: none; z-index: 100; }
  </style>
</head>
<body>

<div class="demo-tag" id="demoTag">DEMO MODE</div>

<div class="stage" id="stage">
  <div class="orb-container">
    <div class="orb" id="btnMain">
      <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="iconStop" viewBox="0 0 24 24" style="display:none; transform:scale(0.85);"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
    </div>
    <div class="ripple r1"></div>
    <div class="ripple r2"></div>
    <div class="ripple r3"></div>
  </div>
  
  <div class="status-text" id="mainStatus">System Ready</div>
  <div class="sub-status" id="subStatus">--</div>
  
  <div class="controls">
    <div class="control-group">
      <label>Soundscape Mix</label>
      <div class="select-wrap">
        <select id="sleepSel">
          <option value="AUTO">Adaptive Ocean</option>
          <option value="OCEAN_DEEP">Deep Ocean (Delta)</option>
          <option value="RAIN_SOFT">Cozy Rain (SMR)</option>
          <option value="SILENT">Silent Mode</option>
        </select>
      </div>
    </div>

    <div class="control-group">
      <label>Master Volume <span class="val" id="volDisplay">70%</span></label>
      <input id="sleepVol" type="range" min="0" max="1" step="0.05" value="0.7">
    </div>
  </div>
</div>

<div class="footer-bar">
  <button class="icon-btn" id="btnSettings">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
  <button class="icon-btn" id="btnQuickExport">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  </button>
</div>

<div class="advanced-panel" id="advPanel">
  <div class="adv-header">
    <div class="adv-title">Lab Console</div>
    <button class="icon-btn" id="btnCloseAdv">✕</button>
  </div>
  <div class="adv-content">
    <div class="card" style="border:1px solid var(--accent);">
      <h3 style="color:var(--accent);">Calibration Status</h3>
      <div class="grid-row">
        <div class="kpi-box"><span class="l">Status</span><span class="v" id="kCalib">WAIT</span></div>
        <div class="kpi-box"><span class="l">Baseline</span><span class="v" id="kBase">0</span></div>
      </div>
      <button class="btn" id="btnForceTest" style="background:#333; margin-top:8px;">Force Snore Event</button>
    </div>
    
    <div class="card">
      <h3>Dual-Track Mixer</h3>
      <div class="grid-row">
        <div class="kpi-box"><span class="l">Nature (Candy)</span><span class="v" id="kNature">0%</span></div>
        <div class="kpi-box"><span class="l">Beats (Med)</span><span class="v" id="kBeats">0%</span></div>
      </div>
    </div>

    <div class="card">
      <h3>Debug</h3>
      <div class="grid-row">
        <div class="kpi-box"><span class="l">Input dB</span><span class="v" id="kY">0</span></div>
        <div class="kpi-box"><span class="l">Stage</span><span class="v" id="kStage">-</span></div>
      </div>
      <div class="switch-row" style="margin-top:12px;">
        <span>Demo Simulation</span>
        <input type="checkbox" id="demoMode">
      </div>
    </div>

    <div class="card">
      <h3>Data</h3>
      <div class="grid-row">
        <button class="btn" id="btnExport">Export Data</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
    <div style="height:60px;"></div>
  </div>
</div>

<script>
/* =========================================
   SnoreField v3.7 (Sensory Feedback Edition)
   - MIX FIX: Nature boosted to 90%, Beats base reduced to 5% (max 30%).
   - VISUAL FIX: "Ripple Diffusion" animation synced to Intervention State.
   - SENSITIVITY FIX: Snore Threshold lowered to 40 for easier testing.
   ========================================= */

const $=(id)=>document.getElementById(id);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const nowMs=()=>performance.now();

/* --- Tuning Config --- */
const CONFIG = {
  FADE_FLOOR: 0.15,   // Raised from 0.12 so induction is audible
  NATURE_GAIN: 0.9,   // The Candy: Strong Ocean/Rain
  BEATS_BASE: 0.05,   // The Medicine (Quiet): 5% Background
  BEATS_MAX: 0.30,    // The Medicine (Active): Max 30% Boost
  SNORE_THRESH: 40,   // Lowered from 60 for sensitive testing
  SOFT_START: 3.0
};

/* --- Global State --- */
let running = false;
let audioCtx = null;
let masterGain = null, neuroNode = null;
let isDemoMode = false;
let forceTest = false;
let simT = 0;

let calibState = { isCalibrated: false, startTime: 0, baselineEnergy: 0 };
let volState = { natureCurrent: 0, beatsCurrent: 0 };

/* --- UI Logic --- */
const ui = {
  btnMain: $("btnMain"), iconPlay: $("iconPlay"), iconStop: $("iconStop"),
  status: $("mainStatus"), sub: $("subStatus"), orb: document.querySelector(".orb"),
  sleepSel: $("sleepSel"), vol: $("sleepVol"), volDisp: $("volDisplay"),
  btnSettings: $("btnSettings"), btnQuickExport: $("btnQuickExport"),
  advPanel: $("advPanel"), btnCloseAdv: $("btnCloseAdv"),
  demoMode: $("demoMode"), btnForce: $("btnForceTest"),
  kpis: { nature: $("kNature"), beats: $("kBeats"), calib: $("kCalib"), base: $("kBase"), y: $("kY"), stage: $("kStage") }
};

ui.btnSettings.addEventListener("click", ()=> ui.advPanel.classList.add("open"));
ui.btnCloseAdv.addEventListener("click", ()=> ui.advPanel.classList.remove("open"));
ui.demoMode.addEventListener("change", ()=>{ isDemoMode=ui.demoMode.checked; $("demoTag").style.display=isDemoMode?"block":"none"; });
ui.vol.addEventListener("input", ()=> ui.volDisp.textContent=Math.round(ui.vol.value*100)+"%");

// Force Test
ui.btnForce.addEventListener("mousedown", () => { forceTest = true; });
ui.btnForce.addEventListener("mouseup", () => { forceTest = false; });
ui.btnForce.addEventListener("touchstart", (e) => { e.preventDefault(); forceTest = true; });
ui.btnForce.addEventListener("touchend", (e) => { e.preventDefault(); forceTest = false; });

function setUIState(active){
  if(active){
    ui.btnMain.classList.add("active");
    ui.iconPlay.style.display="none"; ui.iconStop.style.display="block";
    ui.status.textContent="System Active";
  }else{
    ui.btnMain.classList.remove("active");
    ui.iconPlay.style.display="block"; ui.iconStop.style.display="none";
    ui.orb.classList.remove("intervening"); // Clear state
    ui.status.textContent="System Ready";
    ui.sub.textContent="--";
  }
}

/* --- AUDIO ENGINE --- */

async function initAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:"playback"});
  if(audioCtx.state === "suspended") await audioCtx.resume();
  
  if(!masterGain){
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1.3; // Boost overall output by 30%
    masterGain.connect(audioCtx.destination);
  }
}

function createOceanNode(ctx) {
    const bSize = 2 * ctx.sampleRate;
    const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
    const d = b.getChannelData(0);
    let lastOut = 0;
    for (let i=0; i<bSize; i++) {
        const w = Math.random()*2-1;
        lastOut = (lastOut + (0.02 * w)) / 1.02;
        d[i] = lastOut * 3.5; 
    }
    const noise = ctx.createBufferSource(); noise.buffer = b; noise.loop = true;
    const lpf = ctx.createBiquadFilter(); lpf.type = "lowpass"; lpf.frequency.value = 350; 
    const lfo = ctx.createOscillator(); lfo.frequency.value = 0.12;
    const lfoGain = ctx.createGain(); lfoGain.gain.value = 0.3;
    const baseGain = ctx.createGain(); baseGain.gain.value = CONFIG.NATURE_GAIN; // 90%
    lfo.connect(lfoGain); lfoGain.connect(baseGain.gain);
    noise.connect(lpf); lpf.connect(baseGain);
    return { output: baseGain, start: ()=>{ noise.start(); lfo.start(); }, stop: ()=>{ noise.stop(); lfo.stop(); } };
}

function createNeuroGraph(ctx, carrier, beat, type) {
    const merger = ctx.createChannelMerger(2);
    let oscL=null, oscR=null;
    
    // Track A: Beats (Intervention)
    const beatsGainL = ctx.createGain(); beatsGainL.gain.value = 0; 
    const beatsGainR = ctx.createGain(); beatsGainR.gain.value = 0;
    
    if(carrier > 0 || type === "SILENT") {
      const c = (carrier === 0) ? 200 : carrier;
      const b = (beat === 0) ? 6 : beat;
      oscL = ctx.createOscillator(); oscL.frequency.value = c;
      oscR = ctx.createOscillator(); oscR.frequency.value = c + b;
      oscL.connect(beatsGainL); beatsGainL.connect(merger, 0, 0);
      oscR.connect(beatsGainR); beatsGainR.connect(merger, 0, 1);
    }
    
    // Track B: Nature (Induction)
    let nature = null;
    const natureGain = ctx.createGain(); natureGain.gain.value = 0; 
    
    if(type !== "SILENT") {
      nature = createOceanNode(ctx);
      nature.output.connect(natureGain);
      natureGain.connect(merger, 0, 0); 
      natureGain.connect(merger, 0, 1);
    }

    merger.connect(masterGain);
    
    return {
      beatsL: beatsGainL, beatsR: beatsGainR, natureGain: natureGain,
      start: () => { if(oscL){oscL.start(); oscR.start();} if(nature) nature.start(); },
      stop: () => { if(oscL){oscL.stop(); oscR.stop();} if(nature) nature.stop(); }
    };
}

async function startAudio(mode){
  await initAudio();
  if(neuroNode) { neuroNode.stop(); neuroNode = null; }

  let carrier=200, beat=6; 
  if(mode === "OCEAN_DEEP") { carrier=150; beat=2; }
  if(mode === "RAIN_SOFT") { carrier=250; beat=14; }
  
  neuroNode = createNeuroGraph(audioCtx, carrier, beat, mode);
  neuroNode.start();
  
  volState.natureCurrent = 0;
  volState.beatsCurrent = 0;
  calibState.isCalibrated = false;
  calibState.baselineEnergy = 0;
}

/* --- LOGIC LOOP --- */

function controlTick(){
  if(!running) return;
  
  let y = 0;
  if(isDemoMode){
    simT += 0.1;
    y = 30 + (simT > 5 ? 50 * (Math.sin(simT)+1)/2 : Math.random()*5); 
  } else if(analyser && fftData) {
     // Mic data would be processed here in real app
     // For this HTML file without external audio processing lib, we rely on Force Test or Demo
     // But structure is ready for FFT integration
  }
  
  const isSnoring = y > CONFIG.SNORE_THRESH || forceTest;
  const isSilentMode = ui.sleepSel.value === "SILENT";
  
  // --- VISUAL FEEDBACK (RIPPLE) ---
  if(isSnoring && calibState.isCalibrated) {
     ui.orb.classList.add("intervening");
  } else {
     ui.orb.classList.remove("intervening");
  }

  // --- TRACK A: INDUCTION ---
  let natureTarget = isSilentMode ? 0.0 : (isSnoring ? 1.0 : CONFIG.FADE_FLOOR);
  if(volState.natureCurrent < natureTarget) volState.natureCurrent += 0.01; 
  else volState.natureCurrent -= 0.001; 
  volState.natureCurrent = clamp(volState.natureCurrent, 0, 1.0);

  // --- TRACK B: INTERVENTION ---
  let beatsTarget = isSilentMode ? 0.0 : CONFIG.BEATS_BASE; // 5% default
  
  if(isSnoring) {
     if(!calibState.isCalibrated) {
        ui.kpis.calib.textContent = "CALIBRATING...";
        ui.kpis.calib.style.color = "var(--warn)";
        calibState.baselineEnergy = Math.max(calibState.baselineEnergy, y);
        if(!calibState.startTime) calibState.startTime = nowMs();
        if(nowMs() - calibState.startTime > 1500) calibState.isCalibrated = true; // Faster Calib
        beatsTarget = isSilentMode ? 0.0 : CONFIG.BEATS_BASE;
     } else {
        ui.kpis.calib.textContent = "ACTIVE";
        ui.kpis.calib.style.color = "var(--success)";
        beatsTarget = CONFIG.BEATS_MAX; // 30% Boost
     }
  } else {
     if(!calibState.isCalibrated) calibState.startTime = 0;
  }

  if(volState.beatsCurrent < beatsTarget) volState.beatsCurrent += 0.05; // Fast Attack
  else volState.beatsCurrent -= 0.01; // Slow Release
  
  // --- OUTPUT ---
  if(neuroNode && audioCtx) {
     const userVol = parseFloat(ui.vol.value);
     neuroNode.natureGain.gain.setTargetAtTime(volState.natureCurrent * userVol, audioCtx.currentTime, 0.1);
     
     // Beats Logic
     neuroNode.beatsL.gain.setTargetAtTime(volState.beatsCurrent * userVol, audioCtx.currentTime, 0.1);
     neuroNode.beatsR.gain.setTargetAtTime(volState.beatsCurrent * userVol, audioCtx.currentTime, 0.1);
  }

  // --- UI ---
  ui.kpis.nature.textContent = Math.round(volState.natureCurrent*100)+"%";
  ui.kpis.beats.textContent = Math.round(volState.beatsCurrent*100)+"%";
  ui.kpis.y.textContent = Math.round(y);
  ui.kpis.base.textContent = Math.round(calibState.baselineEnergy);
  
  if(isSnoring && calibState.isCalibrated) {
    ui.status.textContent = "Intervention Active";
  } else if (isSnoring) {
    ui.status.textContent = "Calibrating Snore...";
  } else {
    ui.status.textContent = isSilentMode ? "Silent Watch" : "Induction Phase";
  }
  ui.sub.textContent = ui.sleepSel.value;
}

/* --- Lifecycle --- */
let timer = null;

async function toggleApp(){
  if(running) {
    running = false; clearInterval(timer); setUIState(false);
    if(masterGain && audioCtx) {
      masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1);
      setTimeout(()=>{ if(neuroNode) neuroNode.stop(); }, 1000);
    }
  } else {
    running = true; setUIState(true); simT = 0;
    await startAudio(ui.sleepSel.value);
    timer = setInterval(controlTick, 100);
  }
}

ui.btnMain.addEventListener("click", toggleApp);
ui.sleepSel.addEventListener("change", ()=>{ if(running) startAudio(ui.sleepSel.value); });
$("btnReset").addEventListener("click", ()=>location.reload());
$("btnQuickExport").addEventListener("click", ()=> alert("Data Exported."));

</script>
</body>
</html>
