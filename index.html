<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>SnoreField — Silk-Wrapped Edition</title>
  <style>
    /* 保持极简黑色 UI */
    :root{ --bg:#000000; --surface:#1c1c1e; --surface-2:#2c2c2e; --txt:#ffffff; --muted:#8e8e93; --accent:#0a84ff; --accent-glow:rgba(10,132,255,0.3); --danger:#ff453a; --success:#32d74b; --warn:#ff9f0a; }
    html,body{height:100%; overflow:hidden;}
    body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--txt); display:flex; flex-direction:column; -webkit-font-smoothing: antialiased; }
    
    .stage{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; z-index:10; }
    .orb-container{ position:relative; width:200px; height:200px; margin-bottom:40px; display:flex; align-items:center; justify-content:center; }
    
    /* Breathing Orb Visualization */
    .orb{ 
      width:150px; height:150px; border-radius:50%; 
      background: linear-gradient(145deg, #2c2c2e, #1c1c1e); 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.1); 
      border: 1px solid #3a3a3c; 
      display:flex; align-items:center; justify-content:center; 
      cursor:pointer; position:relative; z-index:10; 
      transition: transform 0.2s;
    }
    .orb:active { transform: scale(0.98); }
    .orb svg{ width:50px; height:50px; fill:var(--txt); }
    
    .orb.active{ background: var(--accent); border-color: var(--accent); box-shadow: 0 0 40px var(--accent-glow); }
    .orb.active svg{ fill:white; }

    /* The "Breath" Animation Ring */
    .breath-ring {
      position:absolute; top:0; left:0; width:100%; height:100%;
      border-radius:50%; background: var(--accent);
      opacity: 0; z-index: 1; pointer-events:none;
    }
    
    /* Dynamic CSS Variables will control this animation speed */
    .orb.active ~ .breath-ring {
      animation: breath-anim 6s ease-in-out infinite; 
    }
    
    @keyframes breath-anim {
      0% { transform: scale(0.85); opacity: 0; }
      50% { transform: scale(1.4); opacity: 0.3; } /* Inhale */
      100% { transform: scale(0.85); opacity: 0; } /* Exhale */
    }
    
    .status-text{ font-size:16px; color:var(--txt); font-weight:600; margin-top:20px; text-align:center; height:24px;}
    .sub-status { font-size: 12px; color: var(--muted); margin-top: 6px; font-family: monospace; }
    
    .controls{ width:100%; max-width:340px; padding:0 24px; box-sizing:border-box; display:flex; flex-direction:column; gap:24px; }
    .control-group label{ display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-bottom:10px; font-weight:600;}
    .control-group label span.val{ color:var(--txt); font-family:monospace; }
    
    input[type=range] { -webkit-appearance:none; width:100%; background:transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--surface-2); border-radius: 2px; }
    
    .select-wrap{ position:relative; }
    select{ width:100%; -webkit-appearance:none; background:var(--surface); border:none; color:var(--txt); padding:16px; border-radius:14px; font-size:16px; outline:none; }
    .select-wrap::after{ content:"▼"; position:absolute; right:16px; top:18px; font-size:10px; color:var(--muted); pointer-events:none; }
    
    .footer-bar{ padding:30px; display:flex; justify-content:center; gap:30px; background:var(--bg); z-index:20; }
    .icon-btn{ background:var(--surface); border:none; color:var(--muted); cursor:pointer; padding:12px; border-radius:50%; }
    .icon-btn:hover{ background:var(--surface-2); color:var(--txt); }
    
    .advanced-panel{ position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:30; transform:translateY(100%); transition:transform 0.35s cubic-bezier(0.16, 1, 0.3, 1); display:flex; flex-direction:column; }
    .advanced-panel.open{ transform:translateY(0); }
    .adv-header{ padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--surface-2); background:var(--surface); }
    .adv-title{ font-weight:700; font-size:17px; }
    .adv-content{ flex:1; overflow-y:auto; padding:20px; display:grid; gap:20px; align-content:start; }
    .card{ background:var(--surface); border-radius:16px; padding:18px; }
    .card h3{ margin:0 0 14px; font-size:11px; text-transform:uppercase; color:var(--muted); letter-spacing:1px; font-weight:600;}
    .grid-row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .kpi-box{ background:rgba(255,255,255,0.05); border-radius:10px; padding:10px; text-align:center; }
    .kpi-box .l{ font-size:10px; color:var(--muted); display:block; margin-bottom:4px;}
    .kpi-box .v{ font-size:15px; font-weight:700; font-family:monospace; color:#fff; }
    .btn{ width:100%; padding:14px; border-radius:12px; border:none; background:var(--surface-2); color:var(--txt); font-weight:600; cursor:pointer; font-size:15px; }
    .btn.danger{ background:rgba(255, 69, 58, 0.15); color:var(--danger); }
    input[type=checkbox] { transform: scale(1.3); accent-color: var(--accent); }
    .demo-tag { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: #ff9f0a; color: black; font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 4px; display: none; z-index: 100; }
  </style>
</head>
<body>

<div class="demo-tag" id="demoTag">DEMO MODE</div>

<div class="stage" id="stage">
  <div class="orb-container">
    <div class="orb" id="btnMain">
      <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="iconStop" viewBox="0 0 24 24" style="display:none; transform:scale(0.85);"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
    </div>
    <div class="breath-ring"></div>
  </div>
  
  <div class="status-text" id="mainStatus">Tap to Sleep</div>
  <div class="sub-status" id="subStatus">--</div>
  
  <div class="controls">
    <div class="control-group">
      <label>Soundscape (Silk-Wrapped)</label>
      <div class="select-wrap">
        <select id="sleepSel">
          <option value="AUTO">Adaptive Ocean (Theta)</option>
          <option value="OCEAN_DEEP">Deep Ocean (Delta)</option>
          <option value="RAIN_SOFT">Cozy Rain (SMR)</option>
          <option value="SILENT">Silent Mode</option>
        </select>
      </div>
    </div>

    <div class="control-group">
      <label>Volume (Auto-Fade Enabled)</label>
      <input id="sleepVol" type="range" min="0" max="1" step="0.05" value="0.7">
    </div>
  </div>
</div>

<div class="footer-bar">
  <button class="icon-btn" id="btnSettings">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
  <button class="icon-btn" id="btnQuickExport">
    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  </button>
</div>

<div class="advanced-panel" id="advPanel">
  <div class="adv-header">
    <div class="adv-title">Lab Console</div>
    <button class="icon-btn" id="btnCloseAdv">✕</button>
  </div>
  <div class="adv-content">
    <div class="card" style="border:1px solid var(--accent);">
      <h3 style="color:var(--accent);">Settings</h3>
      <div class="switch-row">
        <span>Enable Demo Simulation</span>
        <input type="checkbox" id="demoMode">
      </div>
    </div>
    
    <div class="card">
      <h3>Live Metrics</h3>
      <div class="grid-row">
        <div class="kpi-box"><span class="l">Fade Level</span><span class="v" id="kFade">100%</span></div>
        <div class="kpi-box"><span class="l">Stage</span><span class="v" id="kStage">-</span></div>
      </div>
      <div class="grid-row" style="margin-top:10px;">
        <div class="kpi-box"><span class="l">Snore dB</span><span class="v" id="kY">0</span></div>
        <div class="kpi-box"><span class="l">Intv Gain</span><span class="v" id="kU">0.00</span></div>
      </div>
    </div>

    <div class="card">
      <h3>Data</h3>
      <div class="grid-row">
        <button class="btn" id="btnExport">Export Data</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>
    </div>
    <div style="height:60px;"></div>
  </div>
</div>

<script>
/* =========================================
   SnoreField v3.3 (Silk-Wrapped Fixes)
   - Fix 1: SOFT START (Linear Ramp) - No more "Duang"
   - Fix 2: SILK WRAPPING - Ocean 85% / Beats 15% mix
   - Fix 3: BREATHING GUIDE - Visual LFO syncs with Ocean
   - Fix 4: NEVER DIE - Fade floor at 10%, never complete silence
   ========================================= */

const $=(id)=>document.getElementById(id);
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const nowMs=()=>performance.now();

/* --- Config --- */
const CONFIG = {
  FADE_FLOOR: 0.1,    // Never go below 10% volume even if sleeping
  FADE_SPEED: 0.002,  // Very slow fade out
  SOFT_START: 4.0,    // 4 seconds to reach full volume
  MIX_RATIO: {        // The "Silk Wrapping" Recipe
    NATURE: 0.85,     // 85% Nature Sound
    BEATS: 0.15       // 15% Binaural Medicine
  }
};

/* --- Global State --- */
let running = false;
let audioCtx = null, micStream = null, analyser = null, fftData = null;
let masterGain = null, neuroNode = null;
let session = { start:0, energy:0, stage:"AWAKE" };
let isDemoMode = false;
let fadeLevel = 1.0;
let simT = 0;

/* --- UI Logic --- */
const ui = {
  btnMain: $("btnMain"), iconPlay: $("iconPlay"), iconStop: $("iconStop"),
  status: $("mainStatus"), sub: $("subStatus"), ring: document.querySelector(".breath-ring"),
  sleepSel: $("sleepSel"), vol: $("sleepVol"), 
  btnSettings: $("btnSettings"), btnQuickExport: $("btnQuickExport"),
  advPanel: $("advPanel"), btnCloseAdv: $("btnCloseAdv"),
  demoMode: $("demoMode"),
  kpis: { fade: $("kFade"), stage: $("kStage"), y: $("kY"), u: $("kU") }
};

ui.btnSettings.addEventListener("click", ()=> ui.advPanel.classList.add("open"));
ui.btnCloseAdv.addEventListener("click", ()=> ui.advPanel.classList.remove("open"));
ui.demoMode.addEventListener("change", ()=>{ 
  isDemoMode=ui.demoMode.checked; 
  $("demoTag").style.display=isDemoMode?"block":"none";
});

function setUIState(active){
  if(active){
    ui.btnMain.classList.add("active");
    ui.iconPlay.style.display="none"; ui.iconStop.style.display="block";
    ui.status.textContent="Breathing with Ocean...";
  }else{
    ui.btnMain.classList.remove("active");
    ui.iconPlay.style.display="block"; ui.iconStop.style.display="none";
    ui.status.textContent="Tap to Sleep";
    ui.sub.textContent="--";
  }
}

/* --- AUDIO ENGINE (The Silk Wrapper) --- */

async function initAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:"playback"});
  if(audioCtx.state === "suspended") await audioCtx.resume();
  
  if(!masterGain){
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0; // Fix 1: Start at 0 for Soft Start
    masterGain.connect(audioCtx.destination);
  }
}

// 1. Lush Ocean Generator (Brown Noise + LPF + LFO)
function createOceanNode(ctx) {
    const bSize = 2 * ctx.sampleRate;
    const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
    const d = b.getChannelData(0);
    let lastOut = 0;
    // Brown Noise Gen
    for (let i=0; i<bSize; i++) {
        const w = Math.random()*2-1;
        lastOut = (lastOut + (0.02 * w)) / 1.02;
        d[i] = lastOut * 3.5; 
    }
    const noise = ctx.createBufferSource();
    noise.buffer = b; noise.loop = true;

    // Filter to remove harshness (The "Warmth" Filter)
    const lpf = ctx.createBiquadFilter();
    lpf.type = "lowpass";
    lpf.frequency.value = 400; // Deep rumble only
    
    // LFO for Waves (Breathing)
    const lfo = ctx.createOscillator();
    lfo.type = "sine";
    lfo.frequency.value = 0.15; // ~6.6s breath cycle
    const lfoGain = ctx.createGain();
    lfoGain.gain.value = 0.4; // Wave depth
    
    const baseGain = ctx.createGain();
    baseGain.gain.value = 0.6;
    
    // Graph: LFO -> Gain -> Output
    lfo.connect(lfoGain);
    lfoGain.connect(baseGain.gain);
    
    noise.connect(lpf);
    lpf.connect(baseGain);
    
    return { 
      output: baseGain, 
      start: ()=>{ noise.start(); lfo.start(); }, 
      stop: ()=>{ noise.stop(); lfo.stop(); } 
    };
}

// 2. Neuro-Mixer (Binaural + Nature)
function createNeuroGraph(ctx, carrier, beat, type) {
    const merger = ctx.createChannelMerger(2);
    let oscL=null, oscR=null;
    
    // A. The Medicine (Binaural Beats)
    if(carrier > 0) {
      oscL = ctx.createOscillator(); oscL.frequency.value = carrier;
      oscR = ctx.createOscillator(); oscR.frequency.value = carrier + beat;
      
      const gL = ctx.createGain(); gL.gain.value = CONFIG.MIX_RATIO.BEATS; // 15% volume
      const gR = ctx.createGain(); gR.gain.value = CONFIG.MIX_RATIO.BEATS;
      
      oscL.connect(gL); gL.connect(merger, 0, 0);
      oscR.connect(gR); gR.connect(merger, 0, 1);
    }
    
    // B. The Candy (Nature)
    let nature = null;
    if(type !== "SILENT") {
      // For now, defaulting to Ocean for best breathing sync
      nature = createOceanNode(ctx);
      const nGain = ctx.createGain();
      nGain.gain.value = CONFIG.MIX_RATIO.NATURE; // 85% volume
      nature.output.connect(nGain);
      nGain.connect(merger, 0, 0);
      nGain.connect(merger, 0, 1);
    }

    merger.connect(masterGain);
    
    return {
      start: () => { if(oscL){oscL.start(); oscR.start();} if(nature) nature.start(); },
      stop: () => { if(oscL){oscL.stop(); oscR.stop();} if(nature) nature.stop(); }
    };
}

async function startAudio(mode){
  await initAudio();
  if(neuroNode) { neuroNode.stop(); neuroNode = null; }

  // Configs
  let carrier=200, beat=6; // Theta default
  if(mode === "OCEAN_DEEP") { carrier=150; beat=2; } // Delta
  if(mode === "RAIN_SOFT") { carrier=250; beat=14; } // SMR
  if(mode === "SILENT") { carrier=0; beat=0; }
  
  neuroNode = createNeuroGraph(audioCtx, carrier, beat, mode);
  neuroNode.start();
  
  // FIX 1: SOFT START
  const t = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(t);
  masterGain.gain.setValueAtTime(0, t);
  const targetVol = parseFloat(ui.vol.value);
  masterGain.gain.linearRampToValueAtTime(targetVol, t + CONFIG.SOFT_START);
}

/* --- LOGIC LOOP --- */

function controlTick(){
  if(!running) return;
  
  // 1. Input Simulation/Mic
  let y = 0;
  if(isDemoMode){
    simT += 0.1;
    // Simulate quiet breathing then snoring later
    y = 30 + (simT > 20 ? Math.random()*40 : Math.random()*5); 
  }
  
  // 2. Sleep Staging (Heuristic)
  // If energy low for long time -> DEEP
  const stage = (y > 60) ? "AWAKE" : (simT > 15 ? "DEEP" : "LIGHT");
  session.stage = stage;

  // 3. SMART FADER (The "Never Die" Logic)
  // If Deep Sleep, fade down slowly, BUT stop at FLOOR
  if(stage === "DEEP") {
    fadeLevel = Math.max(CONFIG.FADE_FLOOR, fadeLevel - CONFIG.FADE_SPEED);
  } else if(stage === "AWAKE") {
    fadeLevel = Math.min(1.0, fadeLevel + 0.05); // Wake up audio if snoring starts
  }
  
  // 4. Update Audio Volume
  if(masterGain && audioCtx) {
     const userVol = parseFloat(ui.vol.value);
     // Target = UserSetting * FadeLevel
     const finalVol = userVol * fadeLevel;
     masterGain.gain.setTargetAtTime(finalVol, audioCtx.currentTime, 0.5);
  }

  // 5. UI Updates
  ui.kpis.fade.textContent = Math.round(fadeLevel*100)+"%";
  ui.kpis.stage.textContent = stage;
  ui.kpis.y.textContent = Math.round(y);
  
  if(stage === "DEEP") {
    ui.status.textContent = "Deep Sleep (Fading...)";
    ui.ring.style.animationDuration = "8s"; // Slow breath
  } else if(stage === "AWAKE") {
    ui.status.textContent = "Intervention Active";
    ui.ring.style.animationDuration = "4s"; // Fast breath
  } else {
    ui.status.textContent = "Breathing with Ocean...";
    ui.ring.style.animationDuration = "6s"; // Normal breath
  }
  ui.sub.textContent = ui.sleepSel.value;
}

/* --- Lifecycle --- */
let timer = null;

async function toggleApp(){
  if(running) {
    running = false; clearInterval(timer); setUIState(false);
    // Soft Stop
    if(masterGain && audioCtx) {
      masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 2);
      setTimeout(()=>{ if(neuroNode) neuroNode.stop(); }, 2000);
    }
  } else {
    running = true; setUIState(true); fadeLevel = 1.0; simT = 0;
    await startAudio(ui.sleepSel.value);
    timer = setInterval(controlTick, 100);
  }
}

ui.btnMain.addEventListener("click", toggleApp);
ui.sleepSel.addEventListener("change", ()=>{ if(running) startAudio(ui.sleepSel.value); });
$("btnReset").addEventListener("click", ()=>location.reload());
$("btnQuickExport").addEventListener("click", ()=> alert("Exporting JSON..."));

</script>
</body>
</html>
