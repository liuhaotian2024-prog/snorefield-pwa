<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>SnoreField â€” Visual Truth</title>
  <style>
    :root{ --bg:#050505; --surface:#111; --txt:#eee; --accent:#0a84ff; --snore:#00f2ff; --target:#ff9f0a; --intv:#ff3b30; }
    html,body{height:100%; overflow:hidden;}
    body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, monospace; background:var(--bg); color:var(--txt); display:flex; flex-direction:column; }
    
    /* SCOPE AREA */
    .scope-container {
      width: 100%; height: 220px; background: #000;
      position: relative; border-bottom: 1px solid #333;
    }
    canvas { width: 100%; height: 100%; display: block; }
    .scope-legend {
      position: absolute; top: 10px; left: 10px; font-size: 10px; display: flex; gap: 15px; pointer-events: none;
    }
    .legend-item { display: flex; align-items: center; gap: 4px; font-weight: bold; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    
    /* MAIN CONTROLS */
    .main-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; gap: 20px; }
    
    .status-box { text-align: center; }
    .status-main { font-size: 24px; font-weight: 800; letter-spacing: 1px; color: var(--txt); }
    .status-sub { font-size: 12px; color: #666; margin-top: 5px; }
    
    .controls { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; }
    
    .btn-big {
      width: 100%; padding: 18px; border-radius: 12px; border: none;
      background: var(--surface); color: var(--txt); font-size: 16px; font-weight: bold;
      border: 1px solid #333; cursor: pointer; transition: all 0.2s;
      display: flex; justify-content: center; align-items: center; gap: 10px;
    }
    .btn-big.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 20px rgba(10,132,255,0.3); }
    
    .slider-group { background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid #333; }
    .slider-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 10px; }
    input[type=range] { width: 100%; }
    
    /* TEST BUTTON */
    .btn-test {
      background: #222; border: 1px solid #444; color: #888; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; cursor: pointer;
    }
    .btn-test:active { background: var(--snore); color: #000; }

    /* DEBUG PANEL */
    .debug-panel {
      font-family: monospace; font-size: 10px; color: #555; padding: 10px; text-align: center; border-top: 1px solid #222;
    }
  </style>
</head>
<body>

<div class="scope-container">
  <div class="scope-legend">
    <div class="legend-item"><div class="dot" style="background:var(--snore)"></div>SNORE (Input)</div>
    <div class="legend-item"><div class="dot" style="background:var(--target)"></div>Y* (Field)</div>
    <div class="legend-item"><div class="dot" style="background:var(--intv)"></div>STIM (Output)</div>
  </div>
  <canvas id="scope"></canvas>
</div>

<div class="main-area">
  
  <div class="status-box">
    <div class="status-main" id="stMain">SYSTEM READY</div>
    <div class="status-sub" id="stSub">Waiting for Mic Input...</div>
  </div>

  <div class="controls">
    <button class="btn-big" id="btnPower">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      ACTIVATE
    </button>

    <div class="slider-group">
      <div class="slider-header">
        <span>INTERVENTION STRENGTH</span>
        <span id="volVal">70%</span>
      </div>
      <input type="range" id="volRange" min="0" max="1" step="0.05" value="0.7">
    </div>

    <button class="btn-test" id="btnTest">HOLD TO SIMULATE SNORE (FORCE)</button>
  </div>
</div>

<div class="debug-panel" id="debugTxt">Initializing...</div>

<script>
/* =========================================
   SnoreField v4.1 (Visual Truth)
   - Scope: Real-time Canvas drawing of Snore(Blue), Target(Orange), Output(Red).
   - Mic: 5.0x Gain Boost for sensitivity.
   - Ducking: Extreme compression (100% -> 20%) to make Intervention audible.
   ========================================= */

const $ = (id) => document.getElementById(id);
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

// --- CONFIG ---
const CFG = {
  SNORE_THRESH: 35,    // Sensitivity threshold
  MIC_GAIN: 5.0,       // Digital Pre-amp
  NATURE_DUCK: 0.20,   // Nature volume when snoring (20%)
  BEATS_BOOST: 0.80,   // Intervention volume when snoring (80%!)
  FIELD_TAU: 0.1       // Field stiffness (Y* lag)
};

// --- STATE ---
let active = false;
let ctx = null, mic = null, analyser = null, dataArray = null;
let masterGain = null, neuroGain = null, natureGain = null;
let oscL = null, oscR = null, lfo = null; // Audio Nodes

// DATA BUFFERS FOR SCOPE
const HISTORY = 300;
let bufSnore = new Array(HISTORY).fill(0);
let bufYStar = new Array(HISTORY).fill(0);
let bufStim  = new Array(HISTORY).fill(0);

// DYNAMICS
let valSnore = 0;
let valYStar = 0; // The Field Target
let valStim = 0;  // The Red Line
let volNature = 1.0; // The Ducking Envelope

// UI
const canvas = $("scope");
const cCtx = canvas.getContext("2d");
const debug = $("debugTxt");

// --- AUDIO GRAPH ---
async function startAudio() {
  if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  if (ctx.state === 'suspended') await ctx.resume();

  // 1. Microphone (The Ear)
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mic = ctx.createMediaStreamSource(stream);
    analyser = ctx.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.3; // Fast reaction
    mic.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  } catch (e) {
    alert("Mic Error: " + e.message);
    return;
  }

  // 2. Output Graph
  masterGain = ctx.createGain();
  masterGain.connect(ctx.destination);
  masterGain.gain.value = parseFloat($("volRange").value);

  // 3. Nature Track (Pink Noise + LPF) -> Ocean
  // We use simple noise here to ensure browser compatibility and speed
  const bSize = 2 * ctx.sampleRate;
  const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
  const d = b.getChannelData(0);
  for (let i = 0; i < bSize; i++) d[i] = (Math.random() * 2 - 1) * 0.5;
  
  const noise = ctx.createBufferSource();
  noise.buffer = b; noise.loop = true;
  const lpf = ctx.createBiquadFilter();
  lpf.type = "lowpass"; lpf.frequency.value = 400; // Deep Ocean
  natureGain = ctx.createGain();
  natureGain.gain.value = 0.5; // Start volume

  noise.connect(lpf);
  lpf.connect(natureGain);
  natureGain.connect(masterGain);
  noise.start();

  // 4. Neuro-Intervention (Binaural Beats)
  // Left: 200Hz, Right: 206Hz (Theta 6Hz)
  // We use a Merger to force stereo separation
  const merger = ctx.createChannelMerger(2);
  oscL = ctx.createOscillator(); oscL.frequency.value = 200;
  oscR = ctx.createOscillator(); oscR.frequency.value = 206;
  
  // Connect Oscillators to Merger
  const gL = ctx.createGain(); gL.gain.value = 1.0;
  const gR = ctx.createGain(); gR.gain.value = 1.0;
  oscL.connect(gL); gL.connect(merger, 0, 0);
  oscR.connect(gR); gR.connect(merger, 0, 1);

  // Neuro Control Gain
  neuroGain = ctx.createGain();
  neuroGain.gain.value = 0.0; // Start Silent
  merger.connect(neuroGain);
  neuroGain.connect(masterGain);

  oscL.start(); oscR.start();
  
  active = true;
  loop();
  updateUIState();
}

function stopAudio() {
  if (ctx) ctx.close();
  ctx = null;
  active = false;
  updateUIState();
}

// --- CORE LOGIC LOOP (60fps) ---
function loop() {
  if (!active) return;
  requestAnimationFrame(loop);

  // 1. READ SENSOR (The Blue Line)
  analyser.getByteFrequencyData(dataArray);
  let sum = 0;
  // Focus on low freq (Snore range)
  for (let i = 0; i < 30; i++) sum += dataArray[i];
  let rawAvg = sum / 30;
  
  // FORCE BUTTON OVERRIDE
  if($("btnTest").matches(':active')) rawAvg = 100;

  // APPLY DIGITAL GAIN
  valSnore = Math.min(255, rawAvg * CFG.MIC_GAIN);

  // 2. CALCULATE Y* FIELD (The Orange Line)
  // Simple dynamics: Y* follows Snore but with lag
  // dy = (target - y) * tau
  valYStar += (valSnore - valYStar) * CFG.FIELD_TAU;

  // 3. DECISION LOGIC (The Brain)
  const isSnoring = valSnore > CFG.SNORE_THRESH;

  // Target Volumes
  let targetNature = 1.0;
  let targetStim = 0.0; // Default: No intervention

  if (isSnoring) {
    // INTERVENTION MODE
    targetNature = CFG.NATURE_DUCK; // Duck the ocean
    
    // Dynamic Stimulation: Proportional to how much we exceed Y*
    // Stim = (Snore - Threshold) scaled up
    let severity = (valSnore - CFG.SNORE_THRESH) / 100;
    targetStim = clamp(severity * 2.0, 0.1, CFG.BEATS_BOOST); 
  }

  // 4. APPLY ENVELOPES (Smooth Transitions)
  // Nature moves slow (Attack 0.01)
  if(volNature < targetNature) volNature += 0.01; else volNature -= 0.05;
  
  // Stim moves fast (Attack 0.1)
  if(valStim < targetStim) valStim += 0.1; else valStim -= 0.02;

  // Clamp
  volNature = clamp(volNature, 0, 1);
  valStim = clamp(valStim, 0, 1);

  // 5. UPDATE HARDWARE
  if(natureGain) natureGain.gain.setTargetAtTime(volNature, ctx.currentTime, 0.05);
  if(neuroGain) neuroGain.gain.setTargetAtTime(valStim, ctx.currentTime, 0.05);

  // 6. UPDATE BUFFERS (For Chart)
  bufSnore.push(valSnore); bufSnore.shift();
  bufYStar.push(valYStar); bufYStar.shift();
  bufStim.push(valStim * 255); bufStim.shift(); // Scale 0-1 to 0-255 for chart

  // 7. DRAW SCOPE
  drawScope();
  
  // 8. TEXT UPDATE
  debug.textContent = `IN:${Math.round(valSnore)} | Y*:${Math.round(valYStar)} | OUT:${Math.round(valStim*100)}% | DUCK:${Math.round(volNature*100)}%`;
  
  if(isSnoring) {
    $("stMain").textContent = "INTERVENTION ACTIVE";
    $("stMain").style.color = "var(--intv)";
    $("stSub").textContent = "Neuro-Modulation Injected";
  } else {
    $("stMain").textContent = "MONITORING";
    $("stMain").style.color = "var(--txt)";
    $("stSub").textContent = "Induction Phase (Ocean)";
  }
}

// --- VISUALIZATION ---
function drawScope() {
  const w = canvas.width = canvas.offsetWidth;
  const h = canvas.height = canvas.offsetHeight;
  cCtx.clearRect(0, 0, w, h);
  cCtx.lineWidth = 2;

  function drawLine(data, color, dash=[]) {
    cCtx.beginPath();
    cCtx.strokeStyle = color;
    cCtx.setLineDash(dash);
    for (let i = 0; i < data.length; i++) {
      const x = (i / (data.length - 1)) * w;
      const y = h - (data[i] / 255) * h;
      if (i === 0) cCtx.moveTo(x, y); else cCtx.lineTo(x, y);
    }
    cCtx.stroke();
  }

  // Draw Order matters: Stim on top
  drawLine(bufYStar, '#ff9f0a', [5, 5]); // Orange Dashed
  drawLine(bufSnore, '#00f2ff');         // Blue Solid
  
  // Fill Red area when active
  if(valStim > 0.01) {
    cCtx.fillStyle = 'rgba(255, 59, 48, 0.2)';
    cCtx.beginPath();
    cCtx.moveTo(0, h);
    for(let i=0; i<bufStim.length; i++){
       const x = (i / (HISTORY - 1)) * w;
       const y = h - (bufStim[i] / 255) * h;
       cCtx.lineTo(x, y);
    }
    cCtx.lineTo(w, h);
    cCtx.fill();
  }
  drawLine(bufStim, '#ff3b30');          // Red Solid
}

// --- UI HANDLERS ---
function updateUIState() {
  const btn = $("btnPower");
  if(active) {
    btn.innerHTML = "STOP SYSTEM";
    btn.classList.add("active");
  } else {
    btn.innerHTML = "ACTIVATE BAT-MIND";
    btn.classList.remove("active");
    $("stMain").textContent = "SYSTEM OFF";
    $("stSub").textContent = "Press Activate to Start";
  }
}

$("btnPower").addEventListener("click", () => {
  if (active) stopAudio(); else startAudio();
});

$("volRange").addEventListener("input", (e) => {
  $("volVal").textContent = Math.round(e.target.value * 100) + "%";
  if(masterGain) masterGain.gain.value = parseFloat(e.target.value);
});

// Init
updateUIState();

</script>
</body>
</html>
