<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>SnoreField â€” Zero Calibration</title>
  <style>
    :root{ --bg:#000; --txt:#eee; --accent:#0a84ff; --warn:#ff9f0a; --danger:#ff3b30; --safe:#32d74b; }
    html,body{height:100%; overflow:hidden; margin:0; font-family:-apple-system, sans-serif; background:var(--bg); color:var(--txt);}
    
    /* SCOPE */
    .scope-wrap { width:100%; height:240px; background:#111; border-bottom:1px solid #333; position:relative; }
    canvas { width:100%; height:100%; display:block; }
    
    /* STATUS OVERLAY */
    .calib-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); display:flex; flex-direction:column;
      align-items:center; justify-content:center; z-index:10;
      opacity:0; pointer-events:none; transition:opacity 0.3s;
    }
    .calib-overlay.active { opacity:1; }
    .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* CONTROLS */
    .main { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; gap:30px; }
    
    .status-display { text-align:center; }
    .st-main { font-size:20px; font-weight:800; letter-spacing:1px; margin-bottom:5px; }
    .st-sub { font-size:12px; color:#777; font-family:monospace; }

    .btn-power {
      width:260px; height:260px; border-radius:50%; border:2px solid #333;
      background:radial-gradient(circle, #222, #111);
      color:#fff; font-size:18px; font-weight:700; letter-spacing:1px;
      cursor:pointer; transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
    }
    .btn-power:active { transform:scale(0.95); }
    .btn-power.active { border-color:var(--accent); background:radial-gradient(circle, #004080, #000); box-shadow:0 0 50px rgba(10,132,255,0.2); }
    
    .btn-power svg { width:48px; height:48px; fill:currentColor; margin-bottom:5px; }

    .vol-wrap { width:80%; max-width:300px; display:flex; flex-direction:column; gap:10px; }
    .vol-head { display:flex; justify-content:space-between; font-size:12px; color:#888; }
    input[type=range] { width:100%; accent-color:var(--accent); }

    /* DEBUG BAR */
    .debug-bar { padding:10px; font-family:monospace; font-size:10px; color:#555; text-align:center; border-top:1px solid #222; }
  </style>
</head>
<body>

<div class="scope-wrap">
  <div class="calib-overlay" id="calibLayer">
    <div class="spinner"></div>
    <div style="font-weight:bold; color:var(--accent)">CALIBRATING ROOM NOISE...</div>
    <div style="font-size:12px; color:#888; margin-top:5px;">Please keep quiet for 5 seconds</div>
  </div>
  <canvas id="scope"></canvas>
</div>

<div class="main">
  <div class="status-display">
    <div class="st-main" id="stMain">SYSTEM READY</div>
    <div class="st-sub" id="stSub">Auto-Threshold Disabled</div>
  </div>

  <button class="btn-power" id="btnPower">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
    <span>START</span>
  </button>

  <div class="vol-wrap">
    <div class="vol-head"><span>MAX INTERVENTION</span><span id="volVal">70%</span></div>
    <input type="range" id="volRange" min="0" max="1" step="0.05" value="0.7">
  </div>
</div>

<div class="debug-bar" id="debug">v5.0 Zero-Calib</div>

<script>
/* =========================================
   SnoreField v5.0 (Zero-Calibration)
   - FIXED: Removed MIC_GAIN (was 3.0, now 1.0).
   - FIXED: Added 5s Calibration Phase. Measures room noise to set Threshold.
   - FIXED: Real linear fade-in using WebAudio API (No more "Duang").
   - FIXED: Ocean/Beats ratio locked at 70/30.
   ========================================= */

const $ = id => document.getElementById(id);
const clamp = (x,a,b) => Math.max(a,Math.min(b,x));

const CFG = {
  CALIB_TIME: 5000,     // 5 seconds silence check
  BASE_THRESH: 15,      // Minimum snore threshold
  MIC_GAIN: 1.0,        // UNITY GAIN (No artificial boost)
  
  // Audio Mix
  OCEAN_VOL: 0.7,       // 70%
  BEATS_VOL: 0.3,       // 30%
  
  // Ducking
  DUCK_LEVEL: 0.2,      // Ocean drops to 20%
  BOOST_LEVEL: 0.8,     // Beats rise to 80%
  
  FADE_IN: 5.0          // 5 Seconds Fade In
};

// State
let ctx, mic, analyser, dataArray;
let masterGain, natureGain, neuroGain;
let oscL, oscR;
let active = false;
let state = "IDLE"; // IDLE, CALIB, RUN
let startTime = 0;

// Logic State
let ambientNoise = 0;
let dynThreshold = 255; // Start high so we don't trigger during calib
let volNature = 0, volBeats = 0;

// Scope
const cvs = $("scope");
const cCtx = cvs.getContext("2d");
let bufIn = new Array(300).fill(0);
let bufOut = new Array(300).fill(0);

// --- AUDIO SYSTEM ---
async function startSystem() {
  if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
  if(ctx.state==='suspended') await ctx.resume();

  // 1. Mic Setup
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false, noiseSuppression:false}});
    mic = ctx.createMediaStreamSource(stream);
    analyser = ctx.createAnalyser();
    analyser.fftSize = 512;
    analyser.smoothingTimeConstant = 0.6; // Slower, smoother reading
    mic.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  } catch(e) {
    alert("Mic Access Failed"); return;
  }

  // 2. Master Output
  masterGain = ctx.createGain();
  masterGain.connect(ctx.destination);
  masterGain.gain.value = 0; // Start Silent!
  
  // 3. Nature Track (Pink Noise + LPF + LFO)
  const bSize = 2 * ctx.sampleRate;
  const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
  const d = b.getChannelData(0);
  for(let i=0; i<bSize; i++) {
    const w = Math.random()*2-1;
    d[i] = (w * 0.5); // Softer base
  }
  const noise = ctx.createBufferSource();
  noise.buffer = b; noise.loop = true;
  const lpf = ctx.createBiquadFilter(); lpf.type="lowpass"; lpf.frequency.value=300;
  const lfo = ctx.createOscillator(); lfo.frequency.value=0.1; // Breathing wave
  const lfoG = ctx.createGain(); lfoG.gain.value=0.2;
  
  natureGain = ctx.createGain(); 
  natureGain.gain.value = CFG.OCEAN_VOL; 

  lfo.connect(lfoG); lfoG.connect(natureGain.gain);
  noise.connect(lpf); lpf.connect(natureGain);
  natureGain.connect(masterGain);
  
  noise.start(); lfo.start();

  // 4. Neuro Track (Binaural)
  const merger = ctx.createChannelMerger(2);
  oscL = ctx.createOscillator(); oscL.frequency.value=200;
  oscR = ctx.createOscillator(); oscR.frequency.value=206; // 6Hz
  const gL = ctx.createGain(); gL.gain.value=1;
  const gR = ctx.createGain(); gR.gain.value=1;
  oscL.connect(gL); gL.connect(merger, 0, 0);
  oscR.connect(gR); gR.connect(merger, 0, 1);
  
  neuroGain = ctx.createGain();
  neuroGain.gain.value = CFG.BEATS_VOL; // Base level
  merger.connect(neuroGain);
  neuroGain.connect(masterGain);
  
  oscL.start(); oscR.start();

  // 5. Fade In (REAL SMOOTH FADE)
  const t = ctx.currentTime;
  const userVol = parseFloat($("volRange").value);
  masterGain.gain.setValueAtTime(0, t);
  // Linear ramp over 5 seconds to target volume
  masterGain.gain.linearRampToValueAtTime(userVol, t + CFG.FADE_IN);

  // Init Logic
  active = true;
  state = "CALIB";
  startTime = performance.now();
  ambientNoise = 0;
  $("calibLayer").classList.add("active");
  $("btnPower").classList.add("active");
  $("btnPower").innerHTML = `<span>STOP</span>`;
  
  process();
}

function stopSystem() {
  if(ctx) ctx.close();
  ctx = null;
  active = false;
  state = "IDLE";
  $("calibLayer").classList.remove("active");
  $("btnPower").classList.remove("active");
  $("btnPower").innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg><span>START</span>`;
  $("stMain").textContent = "SYSTEM READY";
  $("stSub").textContent = "Auto-Threshold Disabled";
}

// --- LOOP ---
function process() {
  if(!active) return;
  requestAnimationFrame(process);
  
  // 1. Read Mic
  analyser.getByteFrequencyData(dataArray);
  let sum = 0;
  // Look at lowest 10 bins (Deep Snore)
  for(let i=0; i<10; i++) sum += dataArray[i];
  let raw = sum/10;
  
  // Apply Unity Gain (Just raw input)
  let inputVal = raw * CFG.MIC_GAIN;

  // 2. Logic Machine
  let targetOcean = CFG.OCEAN_VOL;
  let targetBeats = CFG.BEATS_VOL;
  let status = "MONITORING";
  let statusColor = "#ccc";

  if (state === "CALIB") {
    // CALIBRATION PHASE
    // Track max ambient noise
    if (inputVal > ambientNoise) ambientNoise = inputVal;
    
    let progress = (performance.now() - startTime);
    if (progress > CFG.CALIB_TIME) {
      state = "RUN";
      // Set threshold slightly above ambient noise
      dynThreshold = Math.max(ambientNoise + 15, CFG.BASE_THRESH); 
      $("calibLayer").classList.remove("active");
    }
  } 
  else if (state === "RUN") {
    // RUNNING PHASE
    if (inputVal > dynThreshold) {
      // SNORE DETECTED
      status = "INTERVENTION ACTIVE";
      statusColor = "var(--danger)";
      
      // Duck Ocean, Boost Beats
      targetOcean = CFG.DUCK_LEVEL;
      targetBeats = CFG.BOOST_LEVEL;
    } else {
      // QUIET
      status = "GUIDED INDUCTION";
      statusColor = "var(--accent)";
    }
  }

  // 3. Audio Actuation (Smooth Envelopes)
  const ct = ctx.currentTime;
  // Apply volume targets
  if(natureGain) natureGain.gain.setTargetAtTime(targetOcean, ct, 0.2); // Slow fade
  if(neuroGain) neuroGain.gain.setTargetAtTime(targetBeats, ct, 0.1); // Fast attack

  // 4. UI Update
  $("stMain").textContent = status;
  $("stMain").style.color = statusColor;
  $("stSub").textContent = state==="CALIB" ? "Learning Environment..." : `Noise:${Math.round(ambientNoise)} | Threshold:${Math.round(dynThreshold)}`;
  
  $("debug").textContent = `IN:${Math.round(inputVal)} | THR:${Math.round(dynThreshold)} | OCEAN:${targetOcean.toFixed(2)} | BEATS:${targetBeats.toFixed(2)}`;

  // 5. Draw Scope
  bufIn.push(inputVal); bufIn.shift();
  
  // Output Visual (Estimate based on target)
  let outVis = (targetBeats > CFG.BEATS_VOL) ? 100 : 0;
  bufOut.push(outVis); bufOut.shift();

  drawScope(dynThreshold);
}

function drawScope(thresh) {
  const w = cvs.width = cvs.offsetWidth;
  const h = cvs.height = cvs.offsetHeight;
  cCtx.clearRect(0,0,w,h);
  
  // Draw Threshold Line
  if(state === "RUN") {
    let yT = h - (thresh/255)*h;
    cCtx.strokeStyle = "#444";
    cCtx.setLineDash([5,5]);
    cCtx.beginPath(); cCtx.moveTo(0,yT); cCtx.lineTo(w,yT); cCtx.stroke();
    cCtx.setLineDash([]);
  }

  // Draw Input
  cCtx.strokeStyle = "var(--snore)";
  cCtx.lineWidth = 2;
  cCtx.beginPath();
  for(let i=0; i<bufIn.length; i++) {
    let x = (i/bufIn.length)*w;
    let y = h - (bufIn[i]/255)*h;
    if(i==0) cCtx.moveTo(x,y); else cCtx.lineTo(x,y);
  }
  cCtx.stroke();

  // Draw Intervention
  cCtx.fillStyle = "rgba(255, 59, 48, 0.3)";
  cCtx.beginPath();
  cCtx.moveTo(0,h);
  for(let i=0; i<bufOut.length; i++) {
    let x = (i/bufOut.length)*w;
    let y = h - (bufOut[i]/150)*h; // Scale down
    cCtx.lineTo(x,y);
  }
  cCtx.lineTo(w,h);
  cCtx.fill();
}

$("btnPower").addEventListener("click", ()=> { if(active) stopSystem(); else startSystem(); });
$("volRange").addEventListener("input", (e)=> {
  $("volVal").textContent = Math.round(e.target.value*100)+"%";
  if(masterGain) masterGain.gain.value = parseFloat(e.target.value);
});

</script>
</body>
</html>
